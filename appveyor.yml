version: '{branch}.{build}'
branches:
  only:
  - master

image: Visual Studio 2017

clone_folder: c:\projects\php-decimal

environment:
  PHP_SDK_BINARY_TOOLS_VER: php-sdk-2.1.1

  matrix:
    - ARCH: 86
      PHP_VER: 7.2
      VC_VER: vc15
    - ARCH: 64
      PHP_VER: 7.2
      VC_VER: vc15
install:
- cmd: cinst wget
build_script:
- cmd: >-
    "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" x%ARCH%

    wget https://github.com/OSTC/php-sdk-binary-tools/archive/%PHP_SDK_BINARY_TOOLS_VER%.zip --no-check-certificate -q -O php-sdk-binary-tools-%PHP_SDK_BINARY_TOOLS_VER%.zip

    7z x -y php-sdk-binary-tools-%PHP_SDK_BINARY_TOOLS_VER%.zip -oC:\projects

    move C:\projects\php-sdk-binary-tools-%PHP_SDK_BINARY_TOOLS_VER% C:\projects\php-sdk

    C:\projects\php-sdk\bin\phpsdk_setvars.bat

    git clone https://github.com/php/php-src C:\projects\php-src -b PHP-%PHP_VER% --depth=1

    mkdir C:\projects\php-src\ext\decimal

    xcopy C:\projects\php-decimal C:\projects\php-src\ext\decimal /s /e /y /q

    phpsdk_deps -u -t %VC_VER% -b %PHP_VER% -a x%ARCH% -f -d C:\projects\php-src\deps

    wget http://www.bytereef.org/software/mpdecimal/releases/mpdecimal-2.4.2.zip -q

    7z x -y mpdecimal-2.4.2.zip -o C:\projects\mpdecimal

    cd C:\projects\mpdecimal

    C:\projects\mpdecimal\vcbuild\vcbuild%ARCH%.bat

    cd C:\projects\mpdecimal\vcbuild
    dir

    cd C:\projects\mpdecimal
    dir

    cd C:\projects\mpdecimal\dist%ARCH%
    dir

    copy C:\projects\mpdecimal\dist%ARCH%\include\mpdecimal.h C:\projects\php-src\deps\include\mpdecimal.h
    copy C:\projects\mpdecimal\dist%ARCH%\lib\mpdecimal.lib C:\projects\php-src\deps\lib\mpdecimal.lib

test_script:
- cmd: >-
    set REPORT_EXIT_STATUS=1

    php.exe /projects/php-src/run-tests.php /projects/php-src/ext/decimal -q --show-diff

artifacts:
  - path: bin
    name: master
    type: zip
